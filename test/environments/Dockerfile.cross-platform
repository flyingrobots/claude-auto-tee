FROM node:18-alpine

# Install cross-platform testing dependencies
RUN apk add --no-cache bash curl git uuid-runtime time

# Install Windows simulation tools for container testing
RUN apk add --no-cache wine

# Create comprehensive test environment
WORKDIR /app

# Copy package files
COPY package*.json ./
RUN npm install

# Copy all source and test files
COPY . .

# Make all scripts executable
RUN chmod +x src/hook.js install.js test/*.js test/**/*.sh

# Create test users for permission testing
RUN addgroup -g 1001 -S testuser && \
    adduser -S testuser -u 1001 -G testuser

RUN addgroup -g 1002 -S restricteduser && \
    adduser -S restricteduser -u 1002 -G restricteduser

# Create various .claude directory scenarios
RUN mkdir -p /home/testuser/.claude
RUN mkdir -p /app/.claude
RUN mkdir -p /tmp/claude-test
RUN chown testuser:testuser /home/testuser/.claude /tmp/claude-test

# Create restricted directories for permission testing
RUN mkdir -p /restricted && chown root:root /restricted && chmod 700 /restricted

# Set up performance monitoring tools
RUN echo '#!/bin/sh\ntime -p "$@"' > /usr/local/bin/timeit && chmod +x /usr/local/bin/timeit

ENTRYPOINT ["/bin/bash"]